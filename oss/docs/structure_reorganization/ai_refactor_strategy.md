# AI時代におけるリファクタリング戦略ガイド

## 概要
本ドキュメントは、AI支援型ソフトウェア開発において「いつ」「なぜ」リファクタリングを行うべきかを体系的にまとめたガイドである。特に、GPT・Claude・Copilot などのAIを組み込んだ開発プロセスにおいて、最も効果的かつ安全なリファクタリング戦略を提供する。

---

## 1. 一般的なリファクタ実施タイミング（Before AI）

| タイミング                         | 理由／目的                                            |
|----------------------------------|------------------------------------------------------|
| 新機能追加前                      | 構造を整理してからの方が、拡張が少ない工数で済む       |
| バグ調査時に複雑なコードに遭遇   | 理解・修正のための読解性向上が目的                     |
| テストが書きづらいと感じた時     | テスト可能な構造（DI/IF分離）への変換                    |
| 複数の責務が1ファイルに混在     | SRP（単一責任原則）違反の修正によって将来的な変更を楽に  |
| 納期前／不安定リリース後        | ⚠️避ける。仕様変化と衝突しやすく、リスクが高い            |

---

## 2. AI時代におけるリファクタ戦略（AI支援前提）

| フェーズ                  | 実施の可否 | 理由 |
|--------------------------|------------|------|
| 初期開発中（仕様不確定） | ❌ 非推奨   | 構造が不安定。再リファクタになりやすい |
| 最初の機能完成直後       | ✅ 推奨     | 実装が出そろい、構造整理しやすい |
| AI出力が冗長化したとき   | ✅ 推奨     | モデルが構造を理解しにくくなり、破綻を防ぐため |
| テスト構造が未整備なとき | ✅ 推奨     | TDD導入を見越した責務分離が必要 |
| モノリスが肥大化し始めた時 | ✅ 強く推奨 | パッケージ分離・責務定義見直しの好機 |

---

## 3. OSS / AI連携プロジェクトでの実施指針

| タイミング                     | 推奨度 | 理由 |
|------------------------------|--------|------|
| ClaudeやGPTが構造出力直後     | ★★★★☆ | 構造責務が明確なタイミング。早めに整理すべき |
| 機能単位の開発完了後           | ★★★★★ | 他層展開前のテンプレート化に最適 |
| 人間が構造設計に迷い始めた時   | ★★☆☆☆ | 設計指針をまず明確にしてからが安全 |

---

## 4. 実施手順テンプレート（AI支援型）

1. **対象層の責務明確化**（鳴瀬または天城が実施）
2. **中継依存の排除箇所特定**（迅人支援可）
3. **責務単位のサブ構造定義**（例：Builders, Diagnostics など）
4. **IF設計と設計テンプレート共有**（司令承認）
5. **実装リファクタ指示をAIへ投入**（鳴瀬に依頼）
6. **詩音によるテスト確認・リグレッション実行**
7. **構造統一・README更新**

---

## 5. 理想的な実施パターン（今回のQueryリファクタ事例）

- 構造設計 → 責務分割（Abstractions/Translation/EventSets）
- 実装移行 → 旧構造の依存排除（KsqlDsl.*）
- テスト維持 → ToKsql()などのユニットテスト通過確認
- テンプレート化 → 他層展開への雛形構造が完成

---

## 6. 備考

- リファクタは**勇気ある知性の投資**である。
- 設計に自信があるときこそ、AIによる拡張性を見越した構造整理が鍵となる。
- 「いつやるか」の判断こそが、AI時代のエンジニアに問われる最大の知性である。

---

> "構造を制す者は、AI開発を制す。"

この指針はプロジェクトの各段階で活用できるよう、他の設計ドキュメントと連携させて展開していくことが推奨される。

