# ガイドライン（Guidelines）

## 1. はじめに

### 本ドキュメントの目的

本ドキュメントは、本OSSライブラリを安全かつ効果的に利用するための基本ルールと推奨事項をまとめたガイドラインです。  
特にKafkaトピックの命名、DLQ設計、POCOクラスの設計など、開発・運用でよく迷うポイントを明確にします。

### 対象読者

- 本OSSを利用してKafka連携アプリケーションを開発するエンジニア  
- Kafkaトピック・スキーマ設計に関わる担当者  
- 本ライブラリの初期導入担当者  

---

## 2. Kafkaの基本

Apache Kafkaは高性能な分散メッセージングプラットフォームです。  
データは「トピック」と呼ばれる単位で管理され、プロデューサーがトピックにメッセージを書き込み、コンシューマーがそれを読み取ります。

本ライブラリでは、C#のPOCOクラスでトピックのデータ構造を定義し、Kafkaのトピックと連携したストリーム処理を行います。

---

## 3. 命名規約の基本ルール

### Kafkaトピック名の付け方

- トピック名は**すべて英小文字**で記述してください。  
- 単語の区切りにはハイフン（`-`）またはアンダースコア（`_`）を使用します。  
- 例：`orders`、`payment_events`、`user_profiles`  
- 空白や特殊記号（例：`@`, `#`, `!`など）は使用禁止です。  
- トピック名の長さは256文字以下を推奨します。  
- 会社名やプロジェクト名のプレフィックスは基本的に付けませんが、必要な場合は運用ルールで統一してください。

### DLQ名の自動生成ルール

- DLQ（Dead Letter Queue）の名前は、対象のトピック名に「-dlq」を付けて自動的に生成されます。  
  例：トピック名が `orders` の場合、DLQ名は `orders-dlq` となります。  
- DLQ名を変更したい場合は、コードで明示的に指定できます。  
  例：`.WithDeadLetterQueue("custom-dlq-name")`  
- DLQ名にもトピック名と同様の命名ルールが適用されます。

---

## 4. DLQの基本運用ルール

### DLQの役割

DLQは処理できなかったメッセージを一時的に退避させるための特別なトピックです。  
後から問題の調査や再処理を行うことが目的です。

### DLQに送る代表的なケース

- メッセージのデシリアライズに失敗した場合。  
- ビジネスロジック上で処理できないデータ不整合が発生した場合。  
- スキーマ互換性違反やフォーマットエラーがあった場合。

### DLQメッセージ構造のポイント

- 原因を特定しやすいように、`errorCode`、`errorMessage`、および元のメッセージ本体（`originalPayload`）を含めることを推奨します。  
- これらのフィールドは標準的に自動付与されますが、必要に応じて拡張可能です。

---

## 5. ストリームとテーブルの簡単判定ルール

### 自動判定基準

- LINQクエリに `GroupBy`、`Aggregate`、`Window` のいずれかが含まれている場合、**テーブル**として扱います。  
- それ以外は、**ストリーム**として扱います。

### 明示的指定

- `.AsStream()` メソッドを使うと、明示的にストリームとして扱います。  
- `.AsTable()` メソッドを使うと、明示的にテーブルとして扱います。  
- 明示指定は自動判定より優先されます。

---

## 6. プロデュース・コンシューム操作の基礎

### AddAsyncによる送信

- Kafkaへのデータ送信は `AddAsync` メソッドを使用します。  
- `AddAsync` は即時送信を行うため、Entity Frameworkのような一括保存（`SaveChanges`）とは異なります。

### 購読時のコミットモード

- デフォルトは自動コミットです。  
- 手動コミットが必要な場合は、クエリ定義時に `.WithManualCommit()` を指定してください。

---

## 7. スキーマと型の基礎

### POCOの基本ルール

- POCOクラスはKafkaトピックのスキーマ定義となります。  
- クラス名がトピック名のベースとなり、プロパティがフィールドに対応します。

### 対応データ型の概要

- 整数型（`int`, `long`）、浮動小数点型（`float`, `double`）、`decimal`（精度指定可）、`bool`、`string`、`DateTime`/`DateTimeOffset`、`Guid`をサポートします。  
- 非対応型や複雑型（例：`char`やコレクション）は使用しないでください。

### decimal精度・日時型の注意点

- `decimal`型は `[DecimalPrecision(precision: 18, scale: 4)]` 属性で精度を指定してください。  
- 日時型は可能な限り `DateTimeOffset` を利用し、タイムゾーンを明確に扱ってください。

### POCOのプロパティ除外（Ignore属性）

- 特定のPOCOプロパティをKafkaスキーマやAvro生成から除外したい場合、  
  `[KafkaIgnore]` 属性を付与して除外可能です。  
- これは必須ではなく任意の拡張機能として提供されます。  
- 利用例：テスト用補助プロパティや、業務スキーマに含めないフィールドの管理に便利です。  

---

## 8. よくある質問（FAQ）

### Q1: トピック名に大文字は使えますか？  
A1: 原則として使わないでください。小文字で統一することでトラブルを避けられます。

### Q2: DLQに入ったメッセージはどうやって再処理しますか？  
A2: DLQからメッセージを読み取り、問題を修正した上で元のトピックに再投入してください。

（以下、適宜追加）

---

## 9. 参考リンク・連絡先

- [Apache Kafka公式サイト](https://kafka.apache.org/)  
- [本プロジェクトGitHubリポジトリ](https://github.com/your-repo)  
- 問い合わせ・フィードバック先: `support@example.com`
